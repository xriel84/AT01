<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AT01 EdBot — Demo Dashboard</title>
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #14141f;
    --border: #2a2a3a;
    --text: #e0e0e0;
    --text-dim: #888;
    --accent: #00d4aa;
    --accent-dim: #00d4aa44;
    --warn: #ffaa00;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'IBM Plex Mono', 'Consolas', monospace;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    padding: 2rem;
  }
  h1 { font-size: 1.4rem; margin-bottom: 0.5rem; }
  .demo-banner {
    background: var(--warn);
    color: #000;
    font-weight: bold;
    text-align: center;
    padding: 6px 12px;
    font-size: 0.75rem;
    letter-spacing: 2px;
    margin-bottom: 1.5rem;
    display: none;
  }
  .status-bar {
    display: flex;
    gap: 1.5rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
  }
  .status-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.8rem;
  }
  .dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: #555;
  }
  .dot.ok { background: #0f0; }
  .dot.warn { background: var(--warn); }
  .dot.err { background: #f44; }
  .status-item .tooltip {
    display: none;
    position: absolute;
    background: #1a1a2e;
    border: 1px solid var(--border);
    padding: 4px 8px;
    font-size: 0.65rem;
    color: var(--text-dim);
    white-space: nowrap;
    top: 100%;
    left: 0;
    margin-top: 4px;
    z-index: 10;
  }
  .status-item { position: relative; }
  .status-item:hover .tooltip { display: block; }
  .section-title {
    font-size: 0.75rem;
    color: var(--text-dim);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 0.75rem;
    margin-top: 1.5rem;
  }
  .section-title:first-of-type { margin-top: 0; }
  .library-summary {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 1rem;
    margin-bottom: 1.5rem;
    display: flex;
    gap: 2rem;
    flex-wrap: wrap;
  }
  .stat { text-align: left; }
  .stat-value {
    font-size: 1.4rem;
    color: var(--accent);
    font-weight: bold;
  }
  .stat-label {
    font-size: 0.7rem;
    color: var(--text-dim);
  }
  .cards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 1.5rem;
    cursor: pointer;
    transition: border-color 0.2s;
    text-decoration: none;
    color: var(--text);
    display: block;
  }
  .card:hover { border-color: var(--accent); }
  .card h2 { font-size: 1rem; margin-bottom: 0.5rem; color: var(--accent); }
  .card p { font-size: 0.8rem; color: var(--text-dim); line-height: 1.5; }
  .metrics-placeholder {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 1rem;
    font-size: 0.75rem;
    color: var(--text-dim);
  }
  .footer {
    font-size: 0.7rem;
    color: var(--text-dim);
    border-top: 1px solid var(--border);
    padding-top: 1rem;
    margin-top: 2rem;
  }
</style>
</head>
<body>
  <div class="demo-banner" id="demoBanner">DEMO MODE — USING TEST DATA</div>
  <h1>AT01 EdBot Pipeline</h1>
  <p style="color:var(--text-dim);font-size:0.8rem;margin-bottom:1.5rem">AI-assisted video editing dashboard</p>

  <div class="status-bar" id="statusBar">
    <div class="status-item"><div class="dot" id="dotServer"></div><span>FastAPI</span><span class="tooltip" id="tipServer">Backend API server (:8901)</span></div>
    <div class="status-item"><div class="dot" id="dotOllama"></div><span>Ollama</span><span class="tooltip" id="tipOllama">Local AI engine (:11434) — powers free-form NLP commands</span></div>
    <div class="status-item"><div class="dot" id="dotResolve"></div><span>Resolve</span><span class="tooltip" id="tipResolve">DaVinci Resolve Studio — edit execution target</span></div>
    <div class="status-item"><div class="dot" id="dotComfyUI"></div><span>ComfyUI</span><span class="tooltip" id="tipComfyUI">Image generation server (:8188) — ArtBot pipeline</span></div>
    <div class="status-item"><div class="dot" id="dotLibrary"></div><span>Library</span><span class="tooltip" id="tipLibrary">Video footage catalog with transcripts</span></div>
  </div>

  <div class="library-summary" id="libSummary" style="display:none">
    <div class="stat">
      <div class="stat-value" id="statVideos">-</div>
      <div class="stat-label">videos</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="statSegments">-</div>
      <div class="stat-label">transcript segments</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="statDuration">-</div>
      <div class="stat-label">total duration</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="statChapters">-</div>
      <div class="stat-label">chapters</div>
    </div>
  </div>

  <div class="section-title">Tools</div>
  <div class="cards">
    <a class="card" href="/frontend/chapter-viewer.html">
      <h2>Chapter Viewer</h2>
      <p>Navigate chapter boundaries, view timeline, search transcripts. Export EDL and marker JSON for Resolve.</p>
    </a>
    <a class="card" href="/frontend/command-console.html">
      <h2>Command Console</h2>
      <p>Type NLP commands to generate edit decisions. Dry-run preview before applying to Resolve timeline.</p>
    </a>
    <a class="card" href="/frontend/nlp-search.html">
      <h2>NLP Search</h2>
      <p>Search across all video transcripts by topic. Find matching chapters and segments with timecodes.</p>
    </a>
    <a class="card" href="/frontend/pipeline.html">
      <h2>Pipeline</h2>
      <p>View the 9-stage automated video pipeline. Track which stages are ready and live processing stats.</p>
    </a>
    <a class="card" href="/docs">
      <h2>API Docs</h2>
      <p>Swagger UI for all EdBot endpoints. Test API calls directly from the browser.</p>
    </a>
  </div>

  <div class="section-title">Agent Activity</div>
  <div class="metrics-placeholder" id="metricsSection">
    Agent metrics: coming soon (Iteration 2)
  </div>

  <div class="footer">
    <div id="statusDetail"></div>
  </div>

<script>
function fmtDuration(sec) {
  if (sec < 60) return Math.round(sec) + 's';
  if (sec < 3600) return Math.floor(sec / 60) + 'm ' + Math.round(sec % 60) + 's';
  const h = Math.floor(sec / 3600);
  const m = Math.floor((sec % 3600) / 60);
  return h + 'h ' + m + 'm';
}

async function checkStatus() {
  const detail = document.getElementById('statusDetail');
  const banner = document.getElementById('demoBanner');
  const info = [];

  // FastAPI server
  try {
    const r = await fetch('/api/health');
    if (r.ok) { dot('dotServer', 'ok'); info.push('FastAPI: up'); }
    else { dot('dotServer', 'err'); info.push('FastAPI: error'); }
  } catch { dot('dotServer', 'err'); info.push('FastAPI: unreachable'); }

  // Ollama
  try {
    const r = await fetch('http://127.0.0.1:11434/api/tags', { signal: AbortSignal.timeout(3000) });
    if (r.ok) {
      const d = await r.json();
      const count = d.models ? d.models.length : 0;
      dot('dotOllama', 'ok');
      tip('tipOllama', 'Online — ' + count + ' models loaded');
      info.push('Ollama: ' + count + ' models');
    } else { dot('dotOllama', 'err'); tip('tipOllama', 'Error — template commands still work'); info.push('Ollama: error'); }
  } catch { dot('dotOllama', 'warn'); tip('tipOllama', 'Offline — template commands still work, free-form needs Ollama'); info.push('Ollama: offline'); }

  // Resolve
  try {
    const r = await fetch('/api/resolve/status');
    const d = await r.json();
    if (d.available) { dot('dotResolve', 'ok'); tip('tipResolve', 'Connected — ' + d.version); info.push('Resolve: ' + d.version); }
    else { dot('dotResolve', 'warn'); tip('tipResolve', 'Offline — dry-run preview still works, launch Resolve to execute edits'); info.push('Resolve: offline'); }
  } catch { dot('dotResolve', 'warn'); tip('tipResolve', 'Offline — dry-run preview still works'); info.push('Resolve: check failed'); }

  // ComfyUI
  try {
    const r = await fetch('http://127.0.0.1:8188/system_stats', { signal: AbortSignal.timeout(3000) });
    if (r.ok) { dot('dotComfyUI', 'ok'); tip('tipComfyUI', 'Online — ready for image generation'); info.push('ComfyUI: up'); }
    else { dot('dotComfyUI', 'warn'); tip('tipComfyUI', 'Error — ArtBot unavailable'); info.push('ComfyUI: error'); }
  } catch { dot('dotComfyUI', 'warn'); tip('tipComfyUI', 'Offline — ArtBot image generation unavailable, not needed for video editing'); info.push('ComfyUI: offline'); }

  // Library
  try {
    const r = await fetch('/api/library');
    const d = await r.json();
    if (d.count > 0) {
      dot('dotLibrary', 'ok');
      info.push('Library: ' + d.count + ' entries');
      if (d.demo_mode) banner.style.display = 'block';
      else banner.style.display = 'none';

      // Compute summary stats
      const entries = d.entries || [];
      let totalSegs = 0, totalDur = 0;
      entries.forEach(e => {
        totalSegs += (e.whisper_segments || []).length;
        totalDur += e.duration || 0;
      });
      document.getElementById('statVideos').textContent = d.count;
      document.getElementById('statSegments').textContent = totalSegs.toLocaleString();
      document.getElementById('statDuration').textContent = fmtDuration(totalDur);
      document.getElementById('libSummary').style.display = 'flex';

      // Fetch chapters for chapter count
      try {
        const cr = await fetch('/api/library/chapters');
        const cd = await cr.json();
        document.getElementById('statChapters').textContent = cd.total_chapters || 0;
      } catch {
        document.getElementById('statChapters').textContent = '?';
      }
    } else { dot('dotLibrary', 'warn'); info.push('Library: empty'); }
  } catch { dot('dotLibrary', 'err'); info.push('Library: load failed'); }

  detail.textContent = info.join(' | ');
}

function dot(id, cls) {
  document.getElementById(id).className = 'dot ' + cls;
}
function tip(id, text) {
  document.getElementById(id).textContent = text;
}

checkStatus();
</script>
</body>
</html>
